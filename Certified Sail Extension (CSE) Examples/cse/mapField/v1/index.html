<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="./map.css"></link>
</head>

<body>
  <div id="map-container"></div>
  <script src='APPIAN_JS_SDK_URI'></script>
  <script>
    var state = {};
    var newKey, newLocation, currentKey;
    var scriptLoaded = false, scriptId = 'scriptTag';

    // Handle a new user input location from SAIL.
    Appian.Component.onNewValue(function (newValues) {
      newKey = newValues.key;
      newLocation = newValues.location;

      if (currentKey !== newKey && newKey !== "") {
        scriptLoaded = false;
        var oldScript = document.getElementById(scriptId);
        if (oldScript) {
          oldScript.parentElement.removeChild(oldScript);
          document.getElementById("map-container").innerHTML = ""
          google = null;
          state = {};
        }

        currentKey = newKey;
        var s = document.createElement( 'script' );
        s.setAttribute('id', scriptId)
        s.setAttribute('src', "https://maps.googleapis.com/maps/api/js?key=" + newKey + "&callback=initMap");
        document.body.appendChild(s);
      }
      if (scriptLoaded && currentLocation !== newLocation) {
        changeLocation(newLocation);
      }
    });

    function initMap() {
      scriptLoaded = true;
      changeLocation(newLocation)
    }

    function changeLocation(newLocation) {
      currentLocation = newLocation;
      // Obtain coordinates for user input location
      state.geocoder = state.geocoder || new google.maps.Geocoder();
      state.geocoder.geocode({ 'address': newLocation }, function (results, status) {
        var latLng = results[0].geometry.location;
        if (state.map) {
          state.map.setCenter(latLng);
        } else {
          renderMap(latLng);
        }
      });
    }

    function renderMap(latLng) {
      // Render a map at the requested coordinates
      state.container = document.getElementById('map-container');
      state.map = new google.maps.Map(state.container, {
        zoom: 12,
        center: latLng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });

      state.map.addListener('click', function (event) {
        if (state.pin) {
          state.pin.setMap(null); // Remove previous pin
        }

        // Add pin with Appian accent color to map
        var pinLatLng = event.latLng;
        state.pin = new google.maps.Marker({
          map: state.map,
          position: pinLatLng,
          icon: {
            fillColor: Appian.getAccentColor(),
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillOpacity: 1,
            strokeWeight: 1
          }
        });

        // Share pin coordinates with SAIL
        Appian.Component.saveValue('pin', {
          latitude: pinLatLng.lat(),
          longitude: pinLatLng.lng()
        });
      });
    }
  </script>
</body>
</html>
